
"use strict"




const fs        = require('fs')
const path      = require('path')
const commons   = require('cloud-init-compile/commons/commons')
const constants = require('cloud-init-compile/commons/constants')





const createScript = (files, toRun) => {

	const hereDocuments = files.map(content => {

		const filename = path.basename(content.fpath)

		return `cat << ${constants.cloudInitDelimiter} > "${filename}"` + '\n' +
			content.content                                             + '\n' +
			constants.cloudInitDelimiter

	})

	return [constants.shebangs.bash]
		.concat(hereDocuments)
		.join('\n')

}





const bundleContent = (fpaths, opts, callback) => {

	commons.async.map(
		fpaths,
		(fpath, fsCallback) => {

			fs.readFile(fpath, (err, content) => {
				fsCallback(err, {fpath, content})
			})

		}, results => {

			results.forEach(result => {

				if (result.err) {
					return console.error('TODO')
				}

			})

			createScript( results.map(result => {

				return {
					fpath:   result.result.fpath,
					content: result.result.content.toString( )
				}

			}) )

		}
	)

}





module.exports = bundleContent
