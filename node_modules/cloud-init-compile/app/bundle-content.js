
"use strict"




const fs        = require('fs')
const path      = require('path')
const commons   = require('cloud-init-compile/commons/commons')
const constants = require('cloud-init-compile/commons/constants')





const createScript = (files, toRun) => {

	const hereDocuments = files.map(content => {

		const filename = path.basename(content.fpath)

		return `cat << ${constants.cloudInitDelimiter} > "${filename}"` + '\n' +
			content.content                                             + '\n' +
			constants.cloudInitDelimiter

	})

	const runName = path.basename(toRun)

	return [constants.shebangs.bash]
		.concat(hereDocuments)
		.concat(
			`chmod +x ${runName} && ${runName}`)
		.join('\n')

}





const bundleContent = (fpaths, opts, callback) => {

	commons.async.map(
		fpaths,
		(fpath, fsCallback) => {

			fs.readFile(fpath, (err, content) => {
				fsCallback(err, {fpath, content})
			})

		}, results => {

			results.forEach(result => {

				if (result.err) {
					return commons.errors.fs(result.err, result.result.fpath)
				}

			})

			console.log(createScript( results.map(result => {

				return {
					fpath:   result.result.fpath,
					content: result.result.content.toString( )
				}

			}), opts.toRun))

		}
	)

}





module.exports = bundleContent
